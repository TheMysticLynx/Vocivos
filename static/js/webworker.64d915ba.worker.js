!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/Vocivos/",n(n.s=41)}([function(e,t,n){e.exports=n(18)},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},function(e,t,n){"use strict";t.load=function(e,t){var n,r,i,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(n in t)i=t[n],s[n]=null!=(r=e[n])?r:i;return s},t.overwrite=function(e,t){var n,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(n in e)r=e[n],void 0!==t[n]&&(i[n]=r);return i}},function(e,t,n){"use strict";var r,i=n(0),s=n(1),o=n(2);function a(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){a(s,r,i,o,u,"next",e)}function u(e){a(s,r,i,o,u,"throw",e)}o(void 0)}))}}r=function(){function e(t){var n=this;if(s(this,e),this.instance=t,this._events={},null!=this.instance.on||null!=this.instance.once||null!=this.instance.removeAllListeners)throw new Error("An Emitter already exists for this object");this.instance.on=function(e,t){return n._addListener(e,"many",t)},this.instance.once=function(e,t){return n._addListener(e,"once",t)},this.instance.removeAllListeners=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null!=e?delete n._events[e]:n._events={}}}return o(e,[{key:"_addListener",value:function(e,t,n){var r;return null==(r=this._events)[e]&&(r[e]=[]),this._events[e].push({cb:n,status:t}),this.instance}},{key:"listenerCount",value:function(e){return null!=this._events[e]?this._events[e].length:0}},{key:"trigger",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var s=this;return u(i.mark((function t(){var r,o;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,"debug"!==e&&s.trigger("debug","Event triggered: ".concat(e),n),null!=s._events[e]){t.next=4;break}return t.abrupt("return");case 4:return s._events[e]=s._events[e].filter((function(e){return"none"!==e.status})),o=s._events[e].map(function(){var e=u(i.mark((function e(t){var r,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("none"!==t.status){e.next=2;break}return e.abrupt("return");case 2:if("once"===t.status&&(t.status="none"),e.prev=3,"function"!==typeof(null!=(o="function"===typeof t.cb?t.cb.apply(t,n):void 0)?o.then:void 0)){e.next=11;break}return e.next=8,o;case 8:return e.abrupt("return",e.sent);case 11:return e.abrupt("return",o);case 12:e.next=19;break;case 14:return e.prev=14,e.t0=e.catch(3),r=e.t0,s.trigger("error",r),e.abrupt("return",null);case 19:case"end":return e.stop()}}),e,null,[[3,14]])})));return function(t){return e.apply(this,arguments)}}()),t.next=8,Promise.all(o);case 8:return t.abrupt("return",t.sent.find((function(e){return null!=e})));case 11:return t.prev=11,t.t0=t.catch(0),r=t.t0,s.trigger("error",r),t.abrupt("return",null);case 16:case"end":return t.stop()}}),t,null,[[0,11]])})))()}}]),e}(),e.exports=r},function(e,t,n){var r=n(19),i=n(20),s=n(21),o=n(22);e.exports=function(e){return r(e)||i(e)||s(e)||o()}},function(e,t,n){"use strict";var r,i=n(1),s=n(25),o=n(26);r=function(e){s(n,e);var t=o(n);function n(){return i(this,n),t.apply(this,arguments)}return n}(n(30)(Error)),e.exports=r},function(e,t){function n(t,r){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,r)}e.exports=n},function(module,exports,__webpack_require__){"use strict";var _regeneratorRuntime=__webpack_require__(0),_classCallCheck=__webpack_require__(1),_createClass=__webpack_require__(2),Events,RedisConnection,Scripts,parser;function asyncGeneratorStep(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){asyncGeneratorStep(s,r,i,o,a,"next",e)}function a(e){asyncGeneratorStep(s,r,i,o,a,"throw",e)}o(void 0)}))}}parser=__webpack_require__(3),Events=__webpack_require__(4),Scripts=__webpack_require__(9),RedisConnection=function(){var RedisConnection=function(){function RedisConnection(){var _this3=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,RedisConnection),parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("redis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null==this.client&&(this.client=this.Redis.createClient(this.clientOptions)),this.subscriber=this.client.duplicate(),this.limiters={},this.shas={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((function(){return _this3._loadScripts()})).then((function(){return{client:_this3.client,subscriber:_this3.subscriber}}))}return _createClass(RedisConnection,[{key:"_setup",value:function(e,t){var n=this;return e.setMaxListeners(0),new this.Promise((function(r,i){return e.on("error",(function(e){return n.Events.trigger("error",e)})),t&&e.on("message",(function(e,t){var r;return null!=(r=n.limiters[e])?r._store.onMessage(e,t):void 0})),e.ready?r():e.once("ready",r)}))}},{key:"_loadScript",value:function(e){var t=this;return new this.Promise((function(n,r){var i;return i=Scripts.payload(e),t.client.multi([["script","load",i]]).exec((function(i,s){return null!=i?r(i):(t.shas[e]=s[0],n(s[0]))}))}))}},{key:"_loadScripts",value:function(){var e=this;return this.Promise.all(Scripts.names.map((function(t){return e._loadScript(t)})))}},{key:"__runCommand__",value:function(e){var t=this;return _asyncToGenerator(_regeneratorRuntime.mark((function n(){return _regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.ready;case 2:return n.abrupt("return",new t.Promise((function(n,r){return t.client.multi([e]).exec_atomic((function(e,t){return null!=e?r(e):n(t[0])}))})));case 3:case"end":return n.stop()}}),n)})))()}},{key:"__addLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map((function(n){return new t.Promise((function(r,i){var s;return s=function(i){if(i===n)return t.subscriber.removeListener("subscribe",s),t.limiters[n]=e,r()},t.subscriber.on("subscribe",s),t.subscriber.subscribe(n)}))})))}},{key:"__removeLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.terminated){e.next=3;break}return e.next=3,new t.Promise((function(e,r){return t.subscriber.unsubscribe(n,(function(t,i){return null!=t?r(t):i===n?e():void 0}))}));case 3:return e.abrupt("return",delete t.limiters[n]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))}},{key:"__scriptArgs__",value:function(e,t,n,r){var i;return i=Scripts.keys(e,t),[this.shas[e],i.length].concat(i,n,r)}},{key:"__scriptFn__",value:function(e){return this.client.evalsha.bind(this.client)}},{key:"disconnect",value:function(){var e,t,n,r,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];for(e=0,n=(r=Object.keys(this.limiters)).length;e<n;e++)t=r[e],clearInterval(this.limiters[t]._store.heartbeat);return this.limiters={},this.terminated=!0,this.client.end(i),this.subscriber.end(i),this.Promise.resolve()}}]),RedisConnection}();return RedisConnection.prototype.datastore="redis",RedisConnection.prototype.defaults={Redis:null,clientOptions:{},client:null,Promise:Promise,Events:null},RedisConnection}.call(void 0),module.exports=RedisConnection},function(e,t,n){"use strict";var r,i,s;i=n(35),r={refs:i["refs.lua"],validate_keys:i["validate_keys.lua"],validate_client:i["validate_client.lua"],refresh_expiration:i["refresh_expiration.lua"],process_tick:i["process_tick.lua"],conditions_check:i["conditions_check.lua"],get_time:i["get_time.lua"]},t.allKeys=function(e){return["b_".concat(e,"_settings"),"b_".concat(e,"_job_weights"),"b_".concat(e,"_job_expirations"),"b_".concat(e,"_job_clients"),"b_".concat(e,"_client_running"),"b_".concat(e,"_client_num_queued"),"b_".concat(e,"_client_last_registered"),"b_".concat(e,"_client_last_seen")]},s={init:{keys:t.allKeys,headers:["process_tick"],refresh_expiration:!0,code:i["init.lua"]},group_check:{keys:t.allKeys,headers:[],refresh_expiration:!1,code:i["group_check.lua"]},register_client:{keys:t.allKeys,headers:["validate_keys"],refresh_expiration:!1,code:i["register_client.lua"]},blacklist_client:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:i["blacklist_client.lua"]},heartbeat:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["heartbeat.lua"]},update_settings:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["update_settings.lua"]},running:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["running.lua"]},queued:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:i["queued.lua"]},done:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["done.lua"]},check:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!1,code:i["check.lua"]},submit:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:i["submit.lua"]},register:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:i["register.lua"]},free:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["free.lua"]},current_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["current_reservoir.lua"]},increment_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["increment_reservoir.lua"]}},t.names=Object.keys(s),t.keys=function(e,t){return s[e].keys(t)},t.payload=function(e){var t;return t=s[e],Array.prototype.concat(r.refs,t.headers.map((function(e){return r[e]})),t.refresh_expiration?r.refresh_expiration:"",t.code).join("\n")}},function(module,exports,__webpack_require__){"use strict";var _regeneratorRuntime=__webpack_require__(0),_classCallCheck=__webpack_require__(1),_createClass=__webpack_require__(2),Events,IORedisConnection,Scripts,parser;function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){asyncGeneratorStep(s,r,i,o,a,"next",e)}function a(e){asyncGeneratorStep(s,r,i,o,a,"throw",e)}o(void 0)}))}}parser=__webpack_require__(3),Events=__webpack_require__(4),Scripts=__webpack_require__(9),IORedisConnection=function(){var IORedisConnection=function(){function IORedisConnection(){var _this3=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,IORedisConnection),parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("ioredis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null!=this.clusterNodes?(this.client=new this.Redis.Cluster(this.clusterNodes,this.clientOptions),this.subscriber=new this.Redis.Cluster(this.clusterNodes,this.clientOptions)):null!=this.client&&null==this.client.duplicate?this.subscriber=new this.Redis.Cluster(this.client.startupNodes,this.client.options):(null==this.client&&(this.client=new this.Redis(this.clientOptions)),this.subscriber=this.client.duplicate()),this.limiters={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((function(){return _this3._loadScripts(),{client:_this3.client,subscriber:_this3.subscriber}}))}return _createClass(IORedisConnection,[{key:"_setup",value:function(e,t){var n=this;return e.setMaxListeners(0),new this.Promise((function(r,i){return e.on("error",(function(e){return n.Events.trigger("error",e)})),t&&e.on("message",(function(e,t){var r;return null!=(r=n.limiters[e])?r._store.onMessage(e,t):void 0})),"ready"===e.status?r():e.once("ready",r)}))}},{key:"_loadScripts",value:function(){var e=this;return Scripts.names.forEach((function(t){return e.client.defineCommand(t,{lua:Scripts.payload(t)})}))}},{key:"__runCommand__",value:function(e){var t=this;return _asyncToGenerator(_regeneratorRuntime.mark((function n(){var r,i,s,o;return _regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.ready;case 2:return n.next=4,t.client.pipeline([e]).exec();case 4:return i=n.sent,s=_slicedToArray(i,1),o=_slicedToArray(s[0],2),o[0],r=o[1],n.abrupt("return",r);case 10:case"end":return n.stop()}}),n)})))()}},{key:"__addLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map((function(n){return new t.Promise((function(r,i){return t.subscriber.subscribe(n,(function(){return t.limiters[n]=e,r()}))}))})))}},{key:"__removeLimiter__",value:function(e){var t=this;return[e.channel(),e.channel_client()].forEach(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.terminated){e.next=3;break}return e.next=3,t.subscriber.unsubscribe(n);case 3:return e.abrupt("return",delete t.limiters[n]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}},{key:"__scriptArgs__",value:function(e,t,n,r){var i;return[(i=Scripts.keys(e,t)).length].concat(i,n,r)}},{key:"__scriptFn__",value:function(e){return this.client[e].bind(this.client)}},{key:"disconnect",value:function(){var e,t,n,r,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];for(e=0,n=(r=Object.keys(this.limiters)).length;e<n;e++)t=r[e],clearInterval(this.limiters[t]._store.heartbeat);return this.limiters={},this.terminated=!0,i?this.Promise.all([this.client.quit(),this.subscriber.quit()]):(this.client.disconnect(),this.subscriber.disconnect(),this.Promise.resolve())}}]),IORedisConnection}();return IORedisConnection.prototype.datastore="ioredis",IORedisConnection.prototype.defaults={Redis:null,clientOptions:{},clusterNodes:null,client:null,Promise:Promise,Events:null},IORedisConnection}.call(void 0),module.exports=IORedisConnection},function(e,t,n){"use strict";var r=n(5),i=n(0),s=n(1),o=n(2);function a(e,t){return l(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}(e,t)||c()}function u(e){return l(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||c()}function c(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function l(e){if(Array.isArray(e))return e}function h(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function p(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){h(s,r,i,o,a,"next",e)}function a(e){h(s,r,i,o,a,"throw",e)}o(void 0)}))}}var f,d,v,_,y,m,g,b,k,w=[].splice;k=n(3),y=n(23),v=n(24),_=n(33),m=n(34),d=n(4),g=n(36),b=n(37),f=function(){var e=function(){function e(){var t,n,r=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,e),this._addToQueue=this._addToQueue.bind(this);for(var o=arguments.length,a=new Array(o>1?o-1:0),u=1;u<o;u++)a[u-1]=arguments[u];this._validateOptions(i,a),k.load(i,this.instanceDefaults,this),this._queues=new y(10),this._scheduled={},this._states=new g(["RECEIVED","QUEUED","RUNNING","EXECUTING"].concat(this.trackDoneStatus?["DONE"]:[])),this._limiter=null,this.Events=new d(this),this._submitLock=new b("submit",this.Promise),this._registerLock=new b("register",this.Promise),n=k.load(i,this.storeDefaults,{}),this._store=function(){if("redis"===this.datastore||"ioredis"===this.datastore||null!=this.connection)return t=k.load(i,this.redisStoreDefaults,{}),new m(this,n,t);if("local"===this.datastore)return t=k.load(i,this.localStoreDefaults,{}),new _(this,n,t);throw new e.prototype.BottleneckError("Invalid datastore type: ".concat(this.datastore))}.call(this),this._queues.on("leftzero",(function(){var e;return null!=(e=r._store.heartbeat)&&"function"===typeof e.ref?e.ref():void 0})),this._queues.on("zero",(function(){var e;return null!=(e=r._store.heartbeat)&&"function"===typeof e.unref?e.unref():void 0}))}return o(e,[{key:"_validateOptions",value:function(t,n){if(null==t||"object"!==typeof t||0!==n.length)throw new e.prototype.BottleneckError("Bottleneck v2 takes a single object argument. Refer to https://github.com/SGrondin/bottleneck#upgrading-to-v2 if you're upgrading from Bottleneck v1.")}},{key:"ready",value:function(){return this._store.ready}},{key:"clients",value:function(){return this._store.clients}},{key:"channel",value:function(){return"b_".concat(this.id)}},{key:"channel_client",value:function(){return"b_".concat(this.id,"_").concat(this._store.clientId)}},{key:"publish",value:function(e){return this._store.__publish__(e)}},{key:"disconnect",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._store.__disconnect__(e)}},{key:"chain",value:function(e){return this._limiter=e,this}},{key:"queued",value:function(e){return this._queues.queued(e)}},{key:"clusterQueued",value:function(){return this._store.__queued__()}},{key:"empty",value:function(){return 0===this.queued()&&this._submitLock.isEmpty()}},{key:"running",value:function(){return this._store.__running__()}},{key:"done",value:function(){return this._store.__done__()}},{key:"jobStatus",value:function(e){return this._states.jobStatus(e)}},{key:"jobs",value:function(e){return this._states.statusJobs(e)}},{key:"counts",value:function(){return this._states.statusCounts()}},{key:"_randomIndex",value:function(){return Math.random().toString(36).slice(2)}},{key:"check",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this._store.__check__(e)}},{key:"_clearGlobalState",value:function(e){return null!=this._scheduled[e]&&(clearTimeout(this._scheduled[e].expiration),delete this._scheduled[e],!0)}},{key:"_free",value:function(e,t,n,r){var s=this;return p(i.mark((function t(){var o,a,u;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,s._store.__free__(e,n.weight);case 3:if(u=t.sent,a=u.running,s.Events.trigger("debug","Freed ".concat(n.id),r),0!==a||!s.empty()){t.next=8;break}return t.abrupt("return",s.Events.trigger("idle"));case 8:t.next=14;break;case 10:return t.prev=10,t.t0=t.catch(0),o=t.t0,t.abrupt("return",s.Events.trigger("error",o));case 14:case"end":return t.stop()}}),t,null,[[0,10]])})))()}},{key:"_run",value:function(e,t,n){var r,i,s,o=this;return t.doRun(),r=this._clearGlobalState.bind(this,e),s=this._run.bind(this,e,t),i=this._free.bind(this,e,t),this._scheduled[e]={timeout:setTimeout((function(){return t.doExecute(o._limiter,r,s,i)}),n),expiration:null!=t.options.expiration?setTimeout((function(){return t.doExpire(r,s,i)}),n+t.options.expiration):void 0,job:t}}},{key:"_drainOne",value:function(e){var t=this;return this._registerLock.schedule((function(){var n,r,i,s,o;if(0===t.queued())return t.Promise.resolve(null);o=t._queues.getFirst();var a=i=o.first();return s=a.options,n=a.args,null!=e&&s.weight>e?t.Promise.resolve(null):(t.Events.trigger("debug","Draining ".concat(s.id),{args:n,options:s}),r=t._randomIndex(),t._store.__register__(r,s.weight,s.expiration).then((function(e){var a,u=e.success,c=e.wait,l=e.reservoir;return t.Events.trigger("debug","Drained ".concat(s.id),{success:u,args:n,options:s}),u?(o.shift(),(a=t.empty())&&t.Events.trigger("empty"),0===l&&t.Events.trigger("depleted",a),t._run(r,i,c),t.Promise.resolve(s.weight)):t.Promise.resolve(null)})))}))}},{key:"_drainAll",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._drainOne(e).then((function(r){var i;return null!=r?(i=null!=e?e-r:e,t._drainAll(i,n+r)):t.Promise.resolve(n)})).catch((function(e){return t.Events.trigger("error",e)}))}},{key:"_dropAllQueued",value:function(e){return this._queues.shiftAll((function(t){return t.doDrop({message:e})}))}},{key:"stop",value:function(){var t,n,r=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return i=k.load(i,this.stopDefaults),n=function(e){var t;return t=function(){var t;return(t=r._states.counts)[0]+t[1]+t[2]+t[3]===e},new r.Promise((function(e,n){return t()?e():r.on("done",(function(){if(t())return r.removeAllListeners("done"),e()}))}))},t=i.dropWaitingJobs?(this._run=function(e,t){return t.doDrop({message:i.dropErrorMessage})},this._drainOne=function(){return r.Promise.resolve(null)},this._registerLock.schedule((function(){return r._submitLock.schedule((function(){var e,t,s;for(e in t=r._scheduled)s=t[e],"RUNNING"===r.jobStatus(s.job.options.id)&&(clearTimeout(s.timeout),clearTimeout(s.expiration),s.job.doDrop({message:i.dropErrorMessage}));return r._dropAllQueued(i.dropErrorMessage),n(0)}))}))):this.schedule({priority:9,weight:0},(function(){return n(1)})),this._receive=function(t){return t._reject(new e.prototype.BottleneckError(i.enqueueErrorMessage))},this.stop=function(){return r.Promise.reject(new e.prototype.BottleneckError("stop() has already been called"))},t}},{key:"_addToQueue",value:function(t){var n=this;return p(i.mark((function r(){var s,o,a,u,c,l,h,p;return i.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s=t.args,u=t.options,r.prev=2,r.next=5,n._store.__submit__(n.queued(),u.weight);case 5:p=r.sent,c=p.reachedHWM,o=p.blocked,h=p.strategy,r.next=17;break;case 11:return r.prev=11,r.t0=r.catch(2),a=r.t0,n.Events.trigger("debug","Could not queue ".concat(u.id),{args:s,options:u,error:a}),t.doDrop({error:a}),r.abrupt("return",!1);case 17:if(!o){r.next=22;break}return t.doDrop(),r.abrupt("return",!0);case 22:if(!c){r.next=28;break}if(null!=(l=h===e.prototype.strategy.LEAK?n._queues.shiftLastFrom(u.priority):h===e.prototype.strategy.OVERFLOW_PRIORITY?n._queues.shiftLastFrom(u.priority+1):h===e.prototype.strategy.OVERFLOW?t:void 0)&&l.doDrop(),null!=l&&h!==e.prototype.strategy.OVERFLOW){r.next=28;break}return null==l&&t.doDrop(),r.abrupt("return",c);case 28:return t.doQueue(c,o),n._queues.push(t),r.next=32,n._drainAll();case 32:return r.abrupt("return",c);case 33:case"end":return r.stop()}}),r,null,[[2,11]])})))()}},{key:"_receive",value:function(t){return null!=this._states.jobStatus(t.options.id)?(t._reject(new e.prototype.BottleneckError("A job with the same id already exists (id=".concat(t.options.id,")"))),!1):(t.doReceive(),this._submitLock.schedule(this._addToQueue,t))}},{key:"submit",value:function(){for(var e,t,n,i,s,o,c,l,h=this,p=arguments.length,f=new Array(p),d=0;d<p;d++)f[d]=arguments[d];"function"===typeof f[0]?(s=u(f),t=s[0],f=s.slice(1),o=a(w.call(f,-1),1),e=o[0],i=k.load({},this.jobDefaults)):(i=(c=u(f))[0],t=c[1],f=c.slice(2),l=a(w.call(f,-1),1),e=l[0],i=k.load(i,this.jobDefaults));return(n=new v((function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new h.Promise((function(e,r){return t.apply(void 0,n.concat([function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return(null!=n[0]?r:e)(n)}]))}))}),f,i,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise)).promise.then((function(t){return"function"===typeof e?e.apply(void 0,r(t)):void 0})).catch((function(t){return Array.isArray(t)?"function"===typeof e?e.apply(void 0,r(t)):void 0:"function"===typeof e?e(t):void 0})),this._receive(n)}},{key:"schedule",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r,i,s;if("function"===typeof t[0]){var o=t,a=u(o);s=a[0],t=a.slice(1),i={}}else{var c=t,l=u(c);i=l[0],s=l[1],t=l.slice(2)}return r=new v(s,t,i,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise),this._receive(r),r.promise}},{key:"wrap",value:function(e){var t,n;return t=this.schedule.bind(this),(n=function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return t.apply(void 0,[e.bind(this)].concat(r))}).withOptions=function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];return t.apply(void 0,[n,e].concat(i))},n}},{key:"updateSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this;return p(i.mark((function n(){return i.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t._store.__updateSettings__(k.overwrite(e,t.storeDefaults));case 2:return k.overwrite(e,t.instanceDefaults,t),n.abrupt("return",t);case 4:case"end":return n.stop()}}),n)})))()}},{key:"currentReservoir",value:function(){return this._store.__currentReservoir__()}},{key:"incrementReservoir",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._store.__incrementReservoir__(e)}}]),e}();return e.default=e,e.Events=d,e.version=e.prototype.version=n(38).version,e.strategy=e.prototype.strategy={LEAK:1,OVERFLOW:2,OVERFLOW_PRIORITY:4,BLOCK:3},e.BottleneckError=e.prototype.BottleneckError=n(6),e.Group=e.prototype.Group=n(39),e.RedisConnection=e.prototype.RedisConnection=n(8),e.IORedisConnection=e.prototype.IORedisConnection=n(10),e.Batcher=e.prototype.Batcher=n(40),e.prototype.jobDefaults={priority:5,weight:1,expiration:null,id:"<no-id>"},e.prototype.storeDefaults={maxConcurrent:null,minTime:0,highWater:null,strategy:e.prototype.strategy.LEAK,penalty:null,reservoir:null,reservoirRefreshInterval:null,reservoirRefreshAmount:null,reservoirIncreaseInterval:null,reservoirIncreaseAmount:null,reservoirIncreaseMaximum:null},e.prototype.localStoreDefaults={Promise:Promise,timeout:null,heartbeatInterval:250},e.prototype.redisStoreDefaults={Promise:Promise,timeout:null,heartbeatInterval:5e3,clientTimeout:1e4,Redis:null,clientOptions:{},clusterNodes:null,clearDatastore:!1,connection:null},e.prototype.instanceDefaults={datastore:"local",connection:null,id:"<no-id>",rejectOnDrop:!0,trackDoneStatus:!1,Promise:Promise},e.prototype.stopDefaults={enqueueErrorMessage:"This limiter has been stopped and cannot accept new jobs.",dropWaitingJobs:!0,dropErrorMessage:"This limiter has been stopped."},e}.call(void 0),e.exports=f},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}},function(e,t,n){"use strict";var r,i=n(1),s=n(2);r=function(){function e(t,n){i(this,e),this.incr=t,this.decr=n,this._first=null,this._last=null,this.length=0}return s(e,[{key:"push",value:function(e){var t;this.length++,"function"===typeof this.incr&&this.incr(),t={value:e,prev:this._last,next:null},null!=this._last?(this._last.next=t,this._last=t):this._first=this._last=t}},{key:"shift",value:function(){var e;if(null!=this._first)return this.length--,"function"===typeof this.decr&&this.decr(),e=this._first.value,null!=(this._first=this._first.next)?this._first.prev=null:this._last=null,e}},{key:"first",value:function(){if(null!=this._first)return this._first.value}},{key:"getArray",value:function(){var e,t,n;for(e=this._first,n=[];null!=e;)n.push((t=e,e=e.next,t.value));return n}},{key:"forEachShift",value:function(e){var t;for(t=this.shift();null!=t;)e(t),t=this.shift()}},{key:"debug",value:function(){var e,t,n,r,i;for(e=this._first,i=[];null!=e;)i.push((t=e,e=e.next,{value:t.value,prev:null!=(n=t.prev)?n.value:void 0,next:null!=(r=t.next)?r.value:void 0}));return i}}]),e}(),e.exports=r},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){e.exports=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}},function(e,t,n){!function(e){"use strict";function t(e){return(t="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t,n){var r,i="";if((e="number"===typeof e?String(e):e).length>t)return e;for(r=0;r<t;r+=1)i+=String(n);return(i+e).slice(-i.length)}function o(){this.reset()}function a(){this.events={}}o.prototype.toString=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:["hours","minutes","seconds"],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:":",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;e=e||["hours","minutes","seconds"],t=t||":",n=n||2;var r,i=[];for(r=0;r<e.length;r+=1)void 0!==this[e[r]]&&("secondTenths"===e[r]?i.push(this[e[r]]):i.push(s(this[e[r]],n,"0")));return i.join(t)},o.prototype.reset=function(){this.secondTenths=0,this.seconds=0,this.minutes=0,this.hours=0,this.days=0},a.prototype.on=function(e,t){var n=this;return Array.isArray(this.events[e])||(this.events[e]=[]),this.events[e].push(t),function(){return n.removeListener(e,t)}},a.prototype.removeListener=function(e,t){if(Array.isArray(this.events[e])){var n=this.events[e].indexOf(t);n>-1&&this.events[e].splice(n,1)}},a.prototype.emit=function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];Array.isArray(this.events[e])&&this.events[e].forEach((function(e){return e.apply(t,r)}))};var u=10,c=60,l=60,h=24,p=0,f=1,d=2,v=3,_=4,y="secondTenths",m="seconds",g="minutes",b="hours",k="days",w=[y,m,g,b,k],x={secondTenths:100,seconds:1e3,minutes:6e4,hours:36e5,days:864e5},R={secondTenths:u,seconds:c,minutes:l,hours:h};function E(e,t){return(e%t+t)%t}function O(){var e,n,r,s,O,S,I,P,j,A,C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},T=new o,q=new o,L=new a,D=!1,G=!1,M={},N={detail:{timer:this}};function z(e,t){var n=R[e];q[e]=t,T[e]=e===k?Math.abs(t):E(t>=0?t:n-E(t,n),n)}function K(e){return W(e,k)}function U(e){return W(e,b)}function V(e){return W(e,g)}function B(e){return W(e,m)}function F(e){return W(e,y)}function W(e,t){var n=q[t];return z(t,ue(e,x[t])),q[t]!==n}function H(){Y(),re()}function Y(){clearInterval(e),e=void 0,D=!1,G=!1}function Q(e){be()?(j=X(),S=ce(O.target)):ie(e),J()}function J(){var t=x[n];ne(ee(Date.now()))||(e=setInterval(Z,t),D=!0,G=!1)}function X(){return ee(Date.now())-q.secondTenths*x[y]*r}function Z(){var e=ee(Date.now());te($()),s(N.detail.timer),ne(e)&&(pe(),me("targetAchieved",N))}function $(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ee(Date.now()),t=r>0?e-j:j-e,n={};return n[y]=F(t),n[m]=B(t),n[g]=V(t),n[b]=U(t),n[k]=K(t),n}function ee(e){return Math.floor(e/x[n])*x[n]}function te(e){e[y]&&me("secondTenthsUpdated",N),e[m]&&me("secondsUpdated",N),e[g]&&me("minutesUpdated",N),e[b]&&me("hoursUpdated",N),e[k]&&me("daysUpdated",N)}function ne(e){return S instanceof Array&&e>=A}function re(){T.reset(),q.reset()}function ie(e){n=se((e=e||{}).precision),s="function"===typeof e.callback?e.callback:function(){},P=!0===e.countdown,r=!0===P?-1:1,"object"===t(e.startValues)?le(e.startValues):I=null,j=X(),$(),"object"===t(e.target)?S=ce(e.target):P?(e.target={seconds:0},S=ce(e.target)):S=null,M={precision:n,callback:s,countdown:"object"===t(e)&&!0===e.countdown,target:S,startValues:I},O=e}function se(e){if(!oe(e="string"===typeof e?e:m))throw new Error("Error in precision parameter: ".concat(e," is not a valid value"));return e}function oe(e){return w.indexOf(e)>=0}function ae(e){var n;if("object"===t(e))if(e instanceof Array){if(5!==e.length)throw new Error("Array size not valid");n=e}else{for(var r in e)if(w.indexOf(r)<0)throw new Error("Error in startValues or target parameter: ".concat(r," is not a valid input value"));n=[e.secondTenths||0,e.seconds||0,e.minutes||0,e.hours||0,e.days||0]}var i=n[p],s=n[f]+ue(i,u),o=n[d]+ue(s,c),a=n[v]+ue(o,l),y=n[_]+ue(a,h);return n[p]=i%u,n[f]=s%c,n[d]=o%l,n[v]=a%h,n[_]=y,n}function ue(e,t){var n=e/t;return n<0?Math.ceil(n):Math.floor(n)}function ce(e){if(e){var t=he(S=ae(e));return A=j+t.secondTenths*x[y]*r,S}}function le(e){I=ae(e),T.secondTenths=I[p],T.seconds=I[f],T.minutes=I[d],T.hours=I[v],T.days=I[_],q=he(I,q)}function he(e,t){var n=t||{};return n.days=e[_],n.hours=n.days*h+e[v],n.minutes=n.hours*l+e[d],n.seconds=n.minutes*c+e[f],n.secondTenths=n.seconds*u+e[[p]],n}function pe(){H(),me("stopped",N)}function fe(){H(),Q(O),me("reset",N)}function de(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e=i(i({},C),e),ge()||(Q(e),me("started",N))}function ve(){Y(),G=!0,me("paused",N)}function _e(e,t){L.on(e,t)}function ye(e,t){L.removeListener(e,t)}function me(e,t){L.emit(e,t)}function ge(){return D}function be(){return G}function ke(){return T}function we(){return q}function xe(){return M}ie(C),"undefined"!==typeof this&&(this.start=de,this.pause=ve,this.stop=pe,this.reset=fe,this.isRunning=ge,this.isPaused=be,this.getTimeValues=ke,this.getTotalTimeValues=we,this.getConfig=xe,this.addEventListener=_e,this.on=_e,this.removeEventListener=ye,this.off=ye)}e.Timer=O,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})}(t)},function(e,t,n){"use strict";e.exports=n(11)},function(e,t,n){var r=function(e){"use strict";var t,n=Object.prototype,r=n.hasOwnProperty,i="function"===typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",o=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(A){u=function(e,t,n){return e[t]=n}}function c(e,t,n,r){var i=t&&t.prototype instanceof _?t:_,s=Object.create(i.prototype),o=new I(r||[]);return s._invoke=function(e,t,n){var r=h;return function(i,s){if(r===f)throw new Error("Generator is already running");if(r===d){if("throw"===i)throw s;return j()}for(n.method=i,n.arg=s;;){var o=n.delegate;if(o){var a=E(o,n);if(a){if(a===v)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=f;var u=l(e,t,n);if("normal"===u.type){if(r=n.done?d:p,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=d,n.method="throw",n.arg=u.arg)}}}(e,n,o),s}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(A){return{type:"throw",arg:A}}}e.wrap=c;var h="suspendedStart",p="suspendedYield",f="executing",d="completed",v={};function _(){}function y(){}function m(){}var g={};g[s]=function(){return this};var b=Object.getPrototypeOf,k=b&&b(b(P([])));k&&k!==n&&r.call(k,s)&&(g=k);var w=m.prototype=_.prototype=Object.create(g);function x(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function R(e,t){function n(i,s,o,a){var u=l(e[i],e,s);if("throw"!==u.type){var c=u.arg,h=c.value;return h&&"object"===typeof h&&r.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(h).then((function(e){c.value=e,o(c)}),(function(e){return n("throw",e,o,a)}))}a(u.arg)}var i;this._invoke=function(e,r){function s(){return new t((function(t,i){n(e,r,t,i)}))}return i=i?i.then(s,s):s()}}function E(e,n){var r=e.iterator[n.method];if(r===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,E(e,n),"throw"===n.method))return v;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return v}var i=l(r,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,v;var s=i.arg;return s?s.done?(n[e.resultName]=s.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,v):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,v)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function P(e){if(e){var n=e[s];if(n)return n.call(e);if("function"===typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}return{next:j}}function j(){return{value:t,done:!0}}return y.prototype=w.constructor=m,m.constructor=y,y.displayName=u(m,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"===typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,a,"GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},x(R.prototype),R.prototype[o]=function(){return this},e.AsyncIterator=R,e.async=function(t,n,r,i,s){void 0===s&&(s=Promise);var o=new R(c(t,n,r,i),s);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},x(w),u(w,a,"Generator"),w[s]=function(){return this},w.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=P,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(S),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return a.type="throw",a.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var u=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(u&&c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var s=i;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,v):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;S(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:P(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),v}},e}(e.exports);try{regeneratorRuntime=r}catch(i){Function("r","regeneratorRuntime = r")(r)}},function(e,t,n){var r=n(12);e.exports=function(e){if(Array.isArray(e))return r(e)}},function(e,t){e.exports=function(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},function(e,t,n){var r=n(12);e.exports=function(e,t){if(e){if("string"===typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(e,t,n){"use strict";var r,i,s,o=n(1),a=n(2);r=n(13),i=n(4),s=function(){function e(t){o(this,e),this.Events=new i(this),this._length=0,this._lists=function(){var e,n,i,s=this;for(i=[],e=1,n=t;1<=n?e<=n:e>=n;1<=n?++e:--e)i.push(new r((function(){return s.incr()}),(function(){return s.decr()})));return i}.call(this)}return a(e,[{key:"incr",value:function(){if(0===this._length++)return this.Events.trigger("leftzero")}},{key:"decr",value:function(){if(0===--this._length)return this.Events.trigger("zero")}},{key:"push",value:function(e){return this._lists[e.options.priority].push(e)}},{key:"queued",value:function(e){return null!=e?this._lists[e].length:this._length}},{key:"shiftAll",value:function(e){return this._lists.forEach((function(t){return t.forEachShift(e)}))}},{key:"getFirst",value:function(){var e,t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._lists;for(e=0,t=r.length;e<t;e++)if((n=r[e]).length>0)return n;return[]}},{key:"shiftLastFrom",value:function(e){return this.getFirst(this._lists.slice(e).reverse()).shift()}}]),e}(),e.exports=s},function(e,t,n){"use strict";var r,i,s,o=n(0),a=n(5),u=n(1),c=n(2);function l(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){l(s,r,i,o,a,"next",e)}function a(e){l(s,r,i,o,a,"throw",e)}o(void 0)}))}}s=n(3),r=n(6),i=function(){function e(t,n,r,i,o,a,c,l){var h=this;u(this,e),this.task=t,this.args=n,this.rejectOnDrop=o,this.Events=a,this._states=c,this.Promise=l,this.options=s.load(r,i),this.options.priority=this._sanitizePriority(this.options.priority),this.options.id===i.id&&(this.options.id="".concat(this.options.id,"-").concat(this._randomIndex())),this.promise=new this.Promise((function(e,t){h._resolve=e,h._reject=t})),this.retryCount=0}return c(e,[{key:"_sanitizePriority",value:function(e){var t;return(t=~~e!==e?5:e)<0?0:t>9?9:t}},{key:"_randomIndex",value:function(){return Math.random().toString(36).slice(2)}},{key:"doDrop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.error,n=e.message,i=void 0===n?"This job has been dropped by Bottleneck":n;return!!this._states.remove(this.options.id)&&(this.rejectOnDrop&&this._reject(null!=t?t:new r(i)),this.Events.trigger("dropped",{args:this.args,options:this.options,task:this.task,promise:this.promise}),!0)}},{key:"_assertStatus",value:function(e){var t;if((t=this._states.jobStatus(this.options.id))!==e&&("DONE"!==e||null!==t))throw new r("Invalid job status ".concat(t,", expected ").concat(e,". Please open an issue at https://github.com/SGrondin/bottleneck/issues"))}},{key:"doReceive",value:function(){return this._states.start(this.options.id),this.Events.trigger("received",{args:this.args,options:this.options})}},{key:"doQueue",value:function(e,t){return this._assertStatus("RECEIVED"),this._states.next(this.options.id),this.Events.trigger("queued",{args:this.args,options:this.options,reachedHWM:e,blocked:t})}},{key:"doRun",value:function(){return 0===this.retryCount?(this._assertStatus("QUEUED"),this._states.next(this.options.id)):this._assertStatus("EXECUTING"),this.Events.trigger("scheduled",{args:this.args,options:this.options})}},{key:"doExecute",value:function(e,t,n,r){var i=this;return h(o.mark((function s(){var u,c,l;return o.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return 0===i.retryCount?(i._assertStatus("RUNNING"),i._states.next(i.options.id)):i._assertStatus("EXECUTING"),c={args:i.args,options:i.options,retryCount:i.retryCount},i.Events.trigger("executing",c),s.prev=3,s.next=6,null!=e?e.schedule.apply(e,[i.options,i.task].concat(a(i.args))):i.task.apply(i,a(i.args));case 6:if(l=s.sent,!t()){s.next=13;break}return i.doDone(c),s.next=11,r(i.options,c);case 11:return i._assertStatus("DONE"),s.abrupt("return",i._resolve(l));case 13:s.next=19;break;case 15:return s.prev=15,s.t0=s.catch(3),u=s.t0,s.abrupt("return",i._onFailure(u,c,t,n,r));case 19:case"end":return s.stop()}}),s,null,[[3,15]])})))()}},{key:"doExpire",value:function(e,t,n){var i,s;return this._states.jobStatus("RUNNING"===this.options.id)&&this._states.next(this.options.id),this._assertStatus("EXECUTING"),s={args:this.args,options:this.options,retryCount:this.retryCount},i=new r("This job timed out after ".concat(this.options.expiration," ms.")),this._onFailure(i,s,e,t,n)}},{key:"_onFailure",value:function(e,t,n,r,i){var s=this;return h(o.mark((function a(){var u,c;return o.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(!n()){o.next=16;break}return o.next=3,s.Events.trigger("failed",e,t);case 3:if(null==(u=o.sent)){o.next=11;break}return c=~~u,s.Events.trigger("retry","Retrying ".concat(s.options.id," after ").concat(c," ms"),t),s.retryCount++,o.abrupt("return",r(c));case 11:return s.doDone(t),o.next=14,i(s.options,t);case 14:return s._assertStatus("DONE"),o.abrupt("return",s._reject(e));case 16:case"end":return o.stop()}}),a)})))()}},{key:"doDone",value:function(e){return this._assertStatus("EXECUTING"),this._states.next(this.options.id),this.Events.trigger("done",e)}}]),e}(),e.exports=i},function(e,t,n){var r=n(7);e.exports=function(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}},function(e,t,n){var r=n(14),i=n(15),s=n(27);e.exports=function(e){var t=i();return function(){var n,i=r(e);if(t){var o=r(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return s(this,n)}}},function(e,t,n){var r=n(28),i=n(29);e.exports=function(e,t){return!t||"object"!==r(t)&&"function"!==typeof t?i(e):t}},function(e,t){function n(t){return"function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?e.exports=n=function(e){return typeof e}:e.exports=n=function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(t)}e.exports=n},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var r=n(14),i=n(7),s=n(31),o=n(32);function a(t){var n="function"===typeof Map?new Map:void 0;return e.exports=a=function(e){if(null===e||!s(e))return e;if("function"!==typeof e)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return o(e,arguments,r(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i(t,e)},a(t)}e.exports=a},function(e,t){e.exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}},function(e,t,n){var r=n(7),i=n(15);function s(t,n,o){return i()?e.exports=s=Reflect.construct:e.exports=s=function(e,t,n){var i=[null];i.push.apply(i,t);var s=new(Function.bind.apply(e,i));return n&&r(s,n.prototype),s},s.apply(null,arguments)}e.exports=s},function(e,t,n){"use strict";var r,i,s,o=n(0),a=n(1),u=n(2);function c(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){c(s,r,i,o,a,"next",e)}function a(e){c(s,r,i,o,a,"throw",e)}o(void 0)}))}}s=n(3),r=n(6),i=function(){function e(t,n,r){a(this,e),this.instance=t,this.storeOptions=n,this.clientId=this.instance._randomIndex(),s.load(r,r,this),this._nextRequest=this._lastReservoirRefresh=this._lastReservoirIncrease=Date.now(),this._running=0,this._done=0,this._unblockTime=0,this.ready=this.Promise.resolve(),this.clients={},this._startHeartbeat()}return u(e,[{key:"_startHeartbeat",value:function(){var e,t=this;return null==this.heartbeat&&(null!=this.storeOptions.reservoirRefreshInterval&&null!=this.storeOptions.reservoirRefreshAmount||null!=this.storeOptions.reservoirIncreaseInterval&&null!=this.storeOptions.reservoirIncreaseAmount)?"function"===typeof(e=this.heartbeat=setInterval((function(){var e,n,r,i,s;if(i=Date.now(),null!=t.storeOptions.reservoirRefreshInterval&&i>=t._lastReservoirRefresh+t.storeOptions.reservoirRefreshInterval&&(t._lastReservoirRefresh=i,t.storeOptions.reservoir=t.storeOptions.reservoirRefreshAmount,t.instance._drainAll(t.computeCapacity())),null!=t.storeOptions.reservoirIncreaseInterval&&i>=t._lastReservoirIncrease+t.storeOptions.reservoirIncreaseInterval){var o=t.storeOptions;if(e=o.reservoirIncreaseAmount,r=o.reservoirIncreaseMaximum,s=o.reservoir,t._lastReservoirIncrease=i,(n=null!=r?Math.min(e,r-s):e)>0)return t.storeOptions.reservoir+=n,t.instance._drainAll(t.computeCapacity())}}),this.heartbeatInterval)).unref?e.unref():void 0:clearInterval(this.heartbeat)}},{key:"__publish__",value:function(e){var t=this;return l(o.mark((function n(){return o.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.yieldLoop();case 2:return n.abrupt("return",t.instance.Events.trigger("message",e.toString()));case 3:case"end":return n.stop()}}),n)})))()}},{key:"__disconnect__",value:function(e){var t=this;return l(o.mark((function e(){return o.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.yieldLoop();case 2:return clearInterval(t.heartbeat),e.abrupt("return",t.Promise.resolve());case 4:case"end":return e.stop()}}),e)})))()}},{key:"yieldLoop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new this.Promise((function(t,n){return setTimeout(t,e)}))}},{key:"computePenalty",value:function(){var e;return null!=(e=this.storeOptions.penalty)?e:15*this.storeOptions.minTime||5e3}},{key:"__updateSettings__",value:function(e){var t=this;return l(o.mark((function n(){return o.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.yieldLoop();case 2:return s.overwrite(e,e,t.storeOptions),t._startHeartbeat(),t.instance._drainAll(t.computeCapacity()),n.abrupt("return",!0);case 6:case"end":return n.stop()}}),n)})))()}},{key:"__running__",value:function(){var e=this;return l(o.mark((function t(){return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.yieldLoop();case 2:return t.abrupt("return",e._running);case 3:case"end":return t.stop()}}),t)})))()}},{key:"__queued__",value:function(){var e=this;return l(o.mark((function t(){return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.yieldLoop();case 2:return t.abrupt("return",e.instance.queued());case 3:case"end":return t.stop()}}),t)})))()}},{key:"__done__",value:function(){var e=this;return l(o.mark((function t(){return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.yieldLoop();case 2:return t.abrupt("return",e._done);case 3:case"end":return t.stop()}}),t)})))()}},{key:"__groupCheck__",value:function(e){var t=this;return l(o.mark((function n(){return o.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.yieldLoop();case 2:return n.abrupt("return",t._nextRequest+t.timeout<e);case 3:case"end":return n.stop()}}),n)})))()}},{key:"computeCapacity",value:function(){var e,t,n=this.storeOptions;return e=n.maxConcurrent,t=n.reservoir,null!=e&&null!=t?Math.min(e-this._running,t):null!=e?e-this._running:null!=t?t:null}},{key:"conditionsCheck",value:function(e){var t;return null==(t=this.computeCapacity())||e<=t}},{key:"__incrementReservoir__",value:function(e){var t=this;return l(o.mark((function n(){var r;return o.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.yieldLoop();case 2:return r=t.storeOptions.reservoir+=e,t.instance._drainAll(t.computeCapacity()),n.abrupt("return",r);case 5:case"end":return n.stop()}}),n)})))()}},{key:"__currentReservoir__",value:function(){var e=this;return l(o.mark((function t(){return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.yieldLoop();case 2:return t.abrupt("return",e.storeOptions.reservoir);case 3:case"end":return t.stop()}}),t)})))()}},{key:"isBlocked",value:function(e){return this._unblockTime>=e}},{key:"check",value:function(e,t){return this.conditionsCheck(e)&&this._nextRequest-t<=0}},{key:"__check__",value:function(e){var t=this;return l(o.mark((function n(){var r;return o.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.yieldLoop();case 2:return r=Date.now(),n.abrupt("return",t.check(e,r));case 4:case"end":return n.stop()}}),n)})))()}},{key:"__register__",value:function(e,t,n){var r=this;return l(o.mark((function e(){var n,i;return o.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.yieldLoop();case 2:if(n=Date.now(),!r.conditionsCheck(t)){e.next=11;break}return r._running+=t,null!=r.storeOptions.reservoir&&(r.storeOptions.reservoir-=t),i=Math.max(r._nextRequest-n,0),r._nextRequest=n+i+r.storeOptions.minTime,e.abrupt("return",{success:!0,wait:i,reservoir:r.storeOptions.reservoir});case 11:return e.abrupt("return",{success:!1});case 12:case"end":return e.stop()}}),e)})))()}},{key:"strategyIsBlock",value:function(){return 3===this.storeOptions.strategy}},{key:"__submit__",value:function(e,t){var n=this;return l(o.mark((function i(){var s,a,u;return o.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,n.yieldLoop();case 2:if(!(null!=n.storeOptions.maxConcurrent&&t>n.storeOptions.maxConcurrent)){i.next=4;break}throw new r("Impossible to add a job having a weight of ".concat(t," to a limiter having a maxConcurrent setting of ").concat(n.storeOptions.maxConcurrent));case 4:return a=Date.now(),u=null!=n.storeOptions.highWater&&e===n.storeOptions.highWater&&!n.check(t,a),(s=n.strategyIsBlock()&&(u||n.isBlocked(a)))&&(n._unblockTime=a+n.computePenalty(),n._nextRequest=n._unblockTime+n.storeOptions.minTime,n.instance._dropAllQueued()),i.abrupt("return",{reachedHWM:u,blocked:s,strategy:n.storeOptions.strategy});case 9:case"end":return i.stop()}}),i)})))()}},{key:"__free__",value:function(e,t){var n=this;return l(o.mark((function e(){return o.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.yieldLoop();case 2:return n._running-=t,n._done+=t,n.instance._drainAll(n.computeCapacity()),e.abrupt("return",{running:n._running});case 6:case"end":return e.stop()}}),e)})))()}}]),e}(),e.exports=i},function(e,t,n){"use strict";var r,i,s,o,a,u=n(5),c=n(0),l=n(1),h=n(2);function p(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){f(s,r,i,o,a,"next",e)}function a(e){f(s,r,i,o,a,"throw",e)}o(void 0)}))}}a=n(3),r=n(6),s=n(8),i=n(10),o=function(){function e(t,n,r){var o=this;l(this,e),this.instance=t,this.storeOptions=n,this.originalId=this.instance.id,this.clientId=this.instance._randomIndex(),a.load(r,r,this),this.clients={},this.capacityPriorityCounters={},this.sharedConnection=null!=this.connection,null==this.connection&&(this.connection="redis"===this.instance.datastore?new s({Redis:this.Redis,clientOptions:this.clientOptions,Promise:this.Promise,Events:this.instance.Events}):"ioredis"===this.instance.datastore?new i({Redis:this.Redis,clientOptions:this.clientOptions,clusterNodes:this.clusterNodes,Promise:this.Promise,Events:this.instance.Events}):void 0),this.instance.connection=this.connection,this.instance.datastore=this.connection.datastore,this.ready=this.connection.ready.then((function(e){return o.clients=e,o.runScript("init",o.prepareInitSettings(o.clearDatastore))})).then((function(){return o.connection.__addLimiter__(o.instance)})).then((function(){return o.runScript("register_client",[o.instance.queued()])})).then((function(){var e;return"function"===typeof(e=o.heartbeat=setInterval((function(){return o.runScript("heartbeat",[]).catch((function(e){return o.instance.Events.trigger("error",e)}))}),o.heartbeatInterval)).unref&&e.unref(),o.clients}))}return h(e,[{key:"__publish__",value:function(e){var t=this;return d(c.mark((function n(){var r,i;return c.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.ready;case 2:return i=n.sent,r=i.client,n.abrupt("return",r.publish(t.instance.channel(),"message:".concat(e.toString())));case 5:case"end":return n.stop()}}),n)})))()}},{key:"onMessage",value:function(e,t){var n=this;return d(c.mark((function e(){var r,i,s,o,a,u,l,h,f,v,_,y,m;return c.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,l=t.indexOf(":"),_=[t.slice(0,l),t.slice(l+1)],s=_[1],"capacity"!==(v=_[0])){e.next=11;break}return e.next=8,n.instance._drainAll(s.length>0?~~s:void 0);case 8:return e.abrupt("return",e.sent);case 11:if("capacity-priority"!==v){e.next=37;break}if(y=s.split(":"),m=p(y,3),f=m[0],h=m[1],i=m[2],r=f.length>0?~~f:void 0,h!==n.clientId){e.next=28;break}return e.next=21,n.instance._drainAll(r);case 21:return o=e.sent,u=null!=r?r-(o||0):"",e.next=25,n.clients.client.publish(n.instance.channel(),"capacity-priority:".concat(u,"::").concat(i));case 25:return e.abrupt("return",e.sent);case 28:if(""!==h){e.next=34;break}return clearTimeout(n.capacityPriorityCounters[i]),delete n.capacityPriorityCounters[i],e.abrupt("return",n.instance._drainAll(r));case 34:return e.abrupt("return",n.capacityPriorityCounters[i]=setTimeout(d(c.mark((function e(){var t;return c.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,delete n.capacityPriorityCounters[i],e.next=4,n.runScript("blacklist_client",[h]);case 4:return e.next=6,n.instance._drainAll(r);case 6:return e.abrupt("return",e.sent);case 9:return e.prev=9,e.t0=e.catch(0),t=e.t0,e.abrupt("return",n.instance.Events.trigger("error",t));case 13:case"end":return e.stop()}}),e,null,[[0,9]])}))),1e3));case 35:e.next=45;break;case 37:if("message"!==v){e.next=41;break}return e.abrupt("return",n.instance.Events.trigger("message",s));case 41:if("blocked"!==v){e.next=45;break}return e.next=44,n.instance._dropAllQueued();case 44:return e.abrupt("return",e.sent);case 45:e.next=51;break;case 47:return e.prev=47,e.t0=e.catch(0),a=e.t0,e.abrupt("return",n.instance.Events.trigger("error",a));case 51:case"end":return e.stop()}}),e,null,[[0,47]])})))()}},{key:"__disconnect__",value:function(e){return clearInterval(this.heartbeat),this.sharedConnection?this.connection.__removeLimiter__(this.instance):this.connection.disconnect(e)}},{key:"runScript",value:function(e,t){var n=this;return d(c.mark((function r(){return c.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if("init"===e||"register_client"===e){r.next=3;break}return r.next=3,n.ready;case 3:return r.abrupt("return",new n.Promise((function(r,i){var s,o;return s=[Date.now(),n.clientId].concat(t),n.instance.Events.trigger("debug","Calling Redis script: ".concat(e,".lua"),s),o=n.connection.__scriptArgs__(e,n.originalId,s,(function(e,t){return null!=e?i(e):r(t)})),n.connection.__scriptFn__(e).apply(void 0,u(o))})).catch((function(r){return"SETTINGS_KEY_NOT_FOUND"===r.message?"heartbeat"===e?n.Promise.resolve():n.runScript("init",n.prepareInitSettings(!1)).then((function(){return n.runScript(e,t)})):"UNKNOWN_CLIENT"===r.message?n.runScript("register_client",[n.instance.queued()]).then((function(){return n.runScript(e,t)})):n.Promise.reject(r)})));case 4:case"end":return r.stop()}}),r)})))()}},{key:"prepareArray",value:function(e){var t,n,r,i;for(r=[],t=0,n=e.length;t<n;t++)i=e[t],r.push(null!=i?i.toString():"");return r}},{key:"prepareObject",value:function(e){var t,n,r;for(n in t=[],e)r=e[n],t.push(n,null!=r?r.toString():"");return t}},{key:"prepareInitSettings",value:function(e){var t;return(t=this.prepareObject(Object.assign({},this.storeOptions,{id:this.originalId,version:this.instance.version,groupTimeout:this.timeout,clientTimeout:this.clientTimeout}))).unshift(e?1:0,this.instance.version),t}},{key:"convertBool",value:function(e){return!!e}},{key:"__updateSettings__",value:function(e){var t=this;return d(c.mark((function n(){return c.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.runScript("update_settings",t.prepareObject(e));case 2:return n.abrupt("return",a.overwrite(e,e,t.storeOptions));case 3:case"end":return n.stop()}}),n)})))()}},{key:"__running__",value:function(){return this.runScript("running",[])}},{key:"__queued__",value:function(){return this.runScript("queued",[])}},{key:"__done__",value:function(){return this.runScript("done",[])}},{key:"__groupCheck__",value:function(){var e=this;return d(c.mark((function t(){return c.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=e,t.next=3,e.runScript("group_check",[]);case 3:return t.t1=t.sent,t.abrupt("return",t.t0.convertBool.call(t.t0,t.t1));case 5:case"end":return t.stop()}}),t)})))()}},{key:"__incrementReservoir__",value:function(e){return this.runScript("increment_reservoir",[e])}},{key:"__currentReservoir__",value:function(){return this.runScript("current_reservoir",[])}},{key:"__check__",value:function(e){var t=this;return d(c.mark((function n(){return c.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=t,n.next=3,t.runScript("check",t.prepareArray([e]));case 3:return n.t1=n.sent,n.abrupt("return",n.t0.convertBool.call(n.t0,n.t1));case 5:case"end":return n.stop()}}),n)})))()}},{key:"__register__",value:function(e,t,n){var r=this;return d(c.mark((function i(){var s,o,a,u,l;return c.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r.runScript("register",r.prepareArray([e,t,n]));case 2:return u=i.sent,l=p(u,3),o=l[0],a=l[1],s=l[2],i.abrupt("return",{success:r.convertBool(o),wait:a,reservoir:s});case 8:case"end":return i.stop()}}),i)})))()}},{key:"__submit__",value:function(e,t){var n=this;return d(c.mark((function i(){var s,o,a,u,l,h,f,d,v;return c.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,n.runScript("submit",n.prepareArray([e,t]));case 3:return h=i.sent,f=p(h,3),u=f[0],s=f[1],l=f[2],i.abrupt("return",{reachedHWM:n.convertBool(u),blocked:n.convertBool(s),strategy:l});case 11:if(i.prev=11,i.t0=i.catch(0),0!==(o=i.t0).message.indexOf("OVERWEIGHT")){i.next=23;break}throw d=o.message.split(":"),v=p(d,3),v[0],t=v[1],a=v[2],new r("Impossible to add a job having a weight of ".concat(t," to a limiter having a maxConcurrent setting of ").concat(a));case 23:throw o;case 24:case"end":return i.stop()}}),i,null,[[0,11]])})))()}},{key:"__free__",value:function(e,t){var n=this;return d(c.mark((function t(){var r;return c.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.runScript("free",n.prepareArray([e]));case 2:return r=t.sent,t.abrupt("return",{running:r});case 4:case"end":return t.stop()}}),t)})))()}}]),e}(),e.exports=o},function(e){e.exports=JSON.parse("{\"blacklist_client.lua\":\"local blacklist = ARGV[num_static_argv + 1]\\n\\nif redis.call('zscore', client_last_seen_key, blacklist) then\\n  redis.call('zadd', client_last_seen_key, 0, blacklist)\\nend\\n\\n\\nreturn {}\\n\",\"check.lua\":\"local weight = tonumber(ARGV[num_static_argv + 1])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\nlocal nextRequest = tonumber(redis.call('hget', settings_key, 'nextRequest'))\\n\\nreturn conditions_check(capacity, weight) and nextRequest - now <= 0\\n\",\"conditions_check.lua\":\"local conditions_check = function (capacity, weight)\\n  return capacity == nil or weight <= capacity\\nend\\n\",\"current_reservoir.lua\":\"return process_tick(now, false)['reservoir']\\n\",\"done.lua\":\"process_tick(now, false)\\n\\nreturn tonumber(redis.call('hget', settings_key, 'done'))\\n\",\"free.lua\":\"local index = ARGV[num_static_argv + 1]\\n\\nredis.call('zadd', job_expirations_key, 0, index)\\n\\nreturn process_tick(now, false)['running']\\n\",\"get_time.lua\":\"redis.replicate_commands()\\n\\nlocal get_time = function ()\\n  local time = redis.call('time')\\n\\n  return tonumber(time[1]..string.sub(time[2], 1, 3))\\nend\\n\",\"group_check.lua\":\"return not (redis.call('exists', settings_key) == 1)\\n\",\"heartbeat.lua\":\"process_tick(now, true)\\n\",\"increment_reservoir.lua\":\"local incr = tonumber(ARGV[num_static_argv + 1])\\n\\nredis.call('hincrby', settings_key, 'reservoir', incr)\\n\\nlocal reservoir = process_tick(now, true)['reservoir']\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn reservoir\\n\",\"init.lua\":\"local clear = tonumber(ARGV[num_static_argv + 1])\\nlocal limiter_version = ARGV[num_static_argv + 2]\\nlocal num_local_argv = num_static_argv + 2\\n\\nif clear == 1 then\\n  redis.call('del', unpack(KEYS))\\nend\\n\\nif redis.call('exists', settings_key) == 0 then\\n  -- Create\\n  local args = {'hmset', settings_key}\\n\\n  for i = num_local_argv + 1, #ARGV do\\n    table.insert(args, ARGV[i])\\n  end\\n\\n  redis.call(unpack(args))\\n  redis.call('hmset', settings_key,\\n    'nextRequest', now,\\n    'lastReservoirRefresh', now,\\n    'lastReservoirIncrease', now,\\n    'running', 0,\\n    'done', 0,\\n    'unblockTime', 0,\\n    'capacityPriorityCounter', 0\\n  )\\n\\nelse\\n  -- Apply migrations\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'version'\\n  )\\n  local id = settings[1]\\n  local current_version = settings[2]\\n\\n  if current_version ~= limiter_version then\\n    local version_digits = {}\\n    for k, v in string.gmatch(current_version, \\\"([^.]+)\\\") do\\n      table.insert(version_digits, tonumber(k))\\n    end\\n\\n    -- 2.10.0\\n    if version_digits[2] < 10 then\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshAmount', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirRefresh', '')\\n      redis.call('hsetnx', settings_key, 'done', 0)\\n      redis.call('hset', settings_key, 'version', '2.10.0')\\n    end\\n\\n    -- 2.11.1\\n    if version_digits[2] < 11 or (version_digits[2] == 11 and version_digits[3] < 1) then\\n      if redis.call('hstrlen', settings_key, 'lastReservoirRefresh') == 0 then\\n        redis.call('hmset', settings_key,\\n          'lastReservoirRefresh', now,\\n          'version', '2.11.1'\\n        )\\n      end\\n    end\\n\\n    -- 2.14.0\\n    if version_digits[2] < 14 then\\n      local old_running_key = 'b_'..id..'_running'\\n      local old_executing_key = 'b_'..id..'_executing'\\n\\n      if redis.call('exists', old_running_key) == 1 then\\n        redis.call('rename', old_running_key, job_weights_key)\\n      end\\n      if redis.call('exists', old_executing_key) == 1 then\\n        redis.call('rename', old_executing_key, job_expirations_key)\\n      end\\n      redis.call('hset', settings_key, 'version', '2.14.0')\\n    end\\n\\n    -- 2.15.2\\n    if version_digits[2] < 15 or (version_digits[2] == 15 and version_digits[3] < 2) then\\n      redis.call('hsetnx', settings_key, 'capacityPriorityCounter', 0)\\n      redis.call('hset', settings_key, 'version', '2.15.2')\\n    end\\n\\n    -- 2.17.0\\n    if version_digits[2] < 17 then\\n      redis.call('hsetnx', settings_key, 'clientTimeout', 10000)\\n      redis.call('hset', settings_key, 'version', '2.17.0')\\n    end\\n\\n    -- 2.18.0\\n    if version_digits[2] < 18 then\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseAmount', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseMaximum', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirIncrease', now)\\n      redis.call('hset', settings_key, 'version', '2.18.0')\\n    end\\n\\n  end\\n\\n  process_tick(now, false)\\nend\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"process_tick.lua\":\"local process_tick = function (now, always_publish)\\n\\n  local compute_capacity = function (maxConcurrent, running, reservoir)\\n    if maxConcurrent ~= nil and reservoir ~= nil then\\n      return math.min((maxConcurrent - running), reservoir)\\n    elseif maxConcurrent ~= nil then\\n      return maxConcurrent - running\\n    elseif reservoir ~= nil then\\n      return reservoir\\n    else\\n      return nil\\n    end\\n  end\\n\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'maxConcurrent',\\n    'running',\\n    'reservoir',\\n    'reservoirRefreshInterval',\\n    'reservoirRefreshAmount',\\n    'lastReservoirRefresh',\\n    'reservoirIncreaseInterval',\\n    'reservoirIncreaseAmount',\\n    'reservoirIncreaseMaximum',\\n    'lastReservoirIncrease',\\n    'capacityPriorityCounter',\\n    'clientTimeout'\\n  )\\n  local id = settings[1]\\n  local maxConcurrent = tonumber(settings[2])\\n  local running = tonumber(settings[3])\\n  local reservoir = tonumber(settings[4])\\n  local reservoirRefreshInterval = tonumber(settings[5])\\n  local reservoirRefreshAmount = tonumber(settings[6])\\n  local lastReservoirRefresh = tonumber(settings[7])\\n  local reservoirIncreaseInterval = tonumber(settings[8])\\n  local reservoirIncreaseAmount = tonumber(settings[9])\\n  local reservoirIncreaseMaximum = tonumber(settings[10])\\n  local lastReservoirIncrease = tonumber(settings[11])\\n  local capacityPriorityCounter = tonumber(settings[12])\\n  local clientTimeout = tonumber(settings[13])\\n\\n  local initial_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  --\\n  -- Process 'running' changes\\n  --\\n  local expired = redis.call('zrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n  if #expired > 0 then\\n    redis.call('zremrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n    local flush_batch = function (batch, acc)\\n      local weights = redis.call('hmget', job_weights_key, unpack(batch))\\n                      redis.call('hdel',  job_weights_key, unpack(batch))\\n      local clients = redis.call('hmget', job_clients_key, unpack(batch))\\n                      redis.call('hdel',  job_clients_key, unpack(batch))\\n\\n      -- Calculate sum of removed weights\\n      for i = 1, #weights do\\n        acc['total'] = acc['total'] + (tonumber(weights[i]) or 0)\\n      end\\n\\n      -- Calculate sum of removed weights by client\\n      local client_weights = {}\\n      for i = 1, #clients do\\n        local removed = tonumber(weights[i]) or 0\\n        if removed > 0 then\\n          acc['client_weights'][clients[i]] = (acc['client_weights'][clients[i]] or 0) + removed\\n        end\\n      end\\n    end\\n\\n    local acc = {\\n      ['total'] = 0,\\n      ['client_weights'] = {}\\n    }\\n    local batch_size = 1000\\n\\n    -- Compute changes to Zsets and apply changes to Hashes\\n    for i = 1, #expired, batch_size do\\n      local batch = {}\\n      for j = i, math.min(i + batch_size - 1, #expired) do\\n        table.insert(batch, expired[j])\\n      end\\n\\n      flush_batch(batch, acc)\\n    end\\n\\n    -- Apply changes to Zsets\\n    if acc['total'] > 0 then\\n      redis.call('hincrby', settings_key, 'done', acc['total'])\\n      running = tonumber(redis.call('hincrby', settings_key, 'running', -acc['total']))\\n    end\\n\\n    for client, weight in pairs(acc['client_weights']) do\\n      redis.call('zincrby', client_running_key, -weight, client)\\n    end\\n  end\\n\\n  --\\n  -- Process 'reservoir' changes\\n  --\\n  local reservoirRefreshActive = reservoirRefreshInterval ~= nil and reservoirRefreshAmount ~= nil\\n  if reservoirRefreshActive and now >= lastReservoirRefresh + reservoirRefreshInterval then\\n    reservoir = reservoirRefreshAmount\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirRefresh', now\\n    )\\n  end\\n\\n  local reservoirIncreaseActive = reservoirIncreaseInterval ~= nil and reservoirIncreaseAmount ~= nil\\n  if reservoirIncreaseActive and now >= lastReservoirIncrease + reservoirIncreaseInterval then\\n    local num_intervals = math.floor((now - lastReservoirIncrease) / reservoirIncreaseInterval)\\n    local incr = reservoirIncreaseAmount * num_intervals\\n    if reservoirIncreaseMaximum ~= nil then\\n      incr = math.min(incr, reservoirIncreaseMaximum - (reservoir or 0))\\n    end\\n    if incr > 0 then\\n      reservoir = (reservoir or 0) + incr\\n    end\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirIncrease', lastReservoirIncrease + (num_intervals * reservoirIncreaseInterval)\\n    )\\n  end\\n\\n  --\\n  -- Clear unresponsive clients\\n  --\\n  local unresponsive = redis.call('zrangebyscore', client_last_seen_key, '-inf', (now - clientTimeout))\\n  local unresponsive_lookup = {}\\n  local terminated_clients = {}\\n  for i = 1, #unresponsive do\\n    unresponsive_lookup[unresponsive[i]] = true\\n    if tonumber(redis.call('zscore', client_running_key, unresponsive[i])) == 0 then\\n      table.insert(terminated_clients, unresponsive[i])\\n    end\\n  end\\n  if #terminated_clients > 0 then\\n    redis.call('zrem', client_running_key,         unpack(terminated_clients))\\n    redis.call('hdel', client_num_queued_key,      unpack(terminated_clients))\\n    redis.call('zrem', client_last_registered_key, unpack(terminated_clients))\\n    redis.call('zrem', client_last_seen_key,       unpack(terminated_clients))\\n  end\\n\\n  --\\n  -- Broadcast capacity changes\\n  --\\n  local final_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  if always_publish or (initial_capacity ~= nil and final_capacity == nil) then\\n    -- always_publish or was not unlimited, now unlimited\\n    redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n\\n  elseif initial_capacity ~= nil and final_capacity ~= nil and final_capacity > initial_capacity then\\n    -- capacity was increased\\n    -- send the capacity message to the limiter having the lowest number of running jobs\\n    -- the tiebreaker is the limiter having not registered a job in the longest time\\n\\n    local lowest_concurrency_value = nil\\n    local lowest_concurrency_clients = {}\\n    local lowest_concurrency_last_registered = {}\\n    local client_concurrencies = redis.call('zrange', client_running_key, 0, -1, 'withscores')\\n\\n    for i = 1, #client_concurrencies, 2 do\\n      local client = client_concurrencies[i]\\n      local concurrency = tonumber(client_concurrencies[i+1])\\n\\n      if (\\n        lowest_concurrency_value == nil or lowest_concurrency_value == concurrency\\n      ) and (\\n        not unresponsive_lookup[client]\\n      ) and (\\n        tonumber(redis.call('hget', client_num_queued_key, client)) > 0\\n      ) then\\n        lowest_concurrency_value = concurrency\\n        table.insert(lowest_concurrency_clients, client)\\n        local last_registered = tonumber(redis.call('zscore', client_last_registered_key, client))\\n        table.insert(lowest_concurrency_last_registered, last_registered)\\n      end\\n    end\\n\\n    if #lowest_concurrency_clients > 0 then\\n      local position = 1\\n      local earliest = lowest_concurrency_last_registered[1]\\n\\n      for i,v in ipairs(lowest_concurrency_last_registered) do\\n        if v < earliest then\\n          position = i\\n          earliest = v\\n        end\\n      end\\n\\n      local next_client = lowest_concurrency_clients[position]\\n      redis.call('publish', 'b_'..id,\\n        'capacity-priority:'..(final_capacity or '')..\\n        ':'..next_client..\\n        ':'..capacityPriorityCounter\\n      )\\n      redis.call('hincrby', settings_key, 'capacityPriorityCounter', '1')\\n    else\\n      redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n    end\\n  end\\n\\n  return {\\n    ['capacity'] = final_capacity,\\n    ['running'] = running,\\n    ['reservoir'] = reservoir\\n  }\\nend\\n\",\"queued.lua\":\"local clientTimeout = tonumber(redis.call('hget', settings_key, 'clientTimeout'))\\nlocal valid_clients = redis.call('zrangebyscore', client_last_seen_key, (now - clientTimeout), 'inf')\\nlocal client_queued = redis.call('hmget', client_num_queued_key, unpack(valid_clients))\\n\\nlocal sum = 0\\nfor i = 1, #client_queued do\\n  sum = sum + tonumber(client_queued[i])\\nend\\n\\nreturn sum\\n\",\"refresh_expiration.lua\":\"local refresh_expiration = function (now, nextRequest, groupTimeout)\\n\\n  if groupTimeout ~= nil then\\n    local ttl = (nextRequest + groupTimeout) - now\\n\\n    for i = 1, #KEYS do\\n      redis.call('pexpire', KEYS[i], ttl)\\n    end\\n  end\\n\\nend\\n\",\"refs.lua\":\"local settings_key = KEYS[1]\\nlocal job_weights_key = KEYS[2]\\nlocal job_expirations_key = KEYS[3]\\nlocal job_clients_key = KEYS[4]\\nlocal client_running_key = KEYS[5]\\nlocal client_num_queued_key = KEYS[6]\\nlocal client_last_registered_key = KEYS[7]\\nlocal client_last_seen_key = KEYS[8]\\n\\nlocal now = tonumber(ARGV[1])\\nlocal client = ARGV[2]\\n\\nlocal num_static_argv = 2\\n\",\"register.lua\":\"local index = ARGV[num_static_argv + 1]\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\nlocal expiration = tonumber(ARGV[num_static_argv + 3])\\n\\nlocal state = process_tick(now, false)\\nlocal capacity = state['capacity']\\nlocal reservoir = state['reservoir']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'nextRequest',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal nextRequest = tonumber(settings[1])\\nlocal minTime = tonumber(settings[2])\\nlocal groupTimeout = tonumber(settings[3])\\n\\nif conditions_check(capacity, weight) then\\n\\n  redis.call('hincrby', settings_key, 'running', weight)\\n  redis.call('hset', job_weights_key, index, weight)\\n  if expiration ~= nil then\\n    redis.call('zadd', job_expirations_key, now + expiration, index)\\n  end\\n  redis.call('hset', job_clients_key, index, client)\\n  redis.call('zincrby', client_running_key, weight, client)\\n  redis.call('hincrby', client_num_queued_key, client, -1)\\n  redis.call('zadd', client_last_registered_key, now, client)\\n\\n  local wait = math.max(nextRequest - now, 0)\\n  local newNextRequest = now + wait + minTime\\n\\n  if reservoir == nil then\\n    redis.call('hset', settings_key,\\n      'nextRequest', newNextRequest\\n    )\\n  else\\n    reservoir = reservoir - weight\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'nextRequest', newNextRequest\\n    )\\n  end\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\n\\n  return {true, wait, reservoir}\\n\\nelse\\n  return {false}\\nend\\n\",\"register_client.lua\":\"local queued = tonumber(ARGV[num_static_argv + 1])\\n\\n-- Could have been re-registered concurrently\\nif not redis.call('zscore', client_last_seen_key, client) then\\n  redis.call('zadd', client_running_key, 0, client)\\n  redis.call('hset', client_num_queued_key, client, queued)\\n  redis.call('zadd', client_last_registered_key, 0, client)\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\\nreturn {}\\n\",\"running.lua\":\"return process_tick(now, false)['running']\\n\",\"submit.lua\":\"local queueLength = tonumber(ARGV[num_static_argv + 1])\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'id',\\n  'maxConcurrent',\\n  'highWater',\\n  'nextRequest',\\n  'strategy',\\n  'unblockTime',\\n  'penalty',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal id = settings[1]\\nlocal maxConcurrent = tonumber(settings[2])\\nlocal highWater = tonumber(settings[3])\\nlocal nextRequest = tonumber(settings[4])\\nlocal strategy = tonumber(settings[5])\\nlocal unblockTime = tonumber(settings[6])\\nlocal penalty = tonumber(settings[7])\\nlocal minTime = tonumber(settings[8])\\nlocal groupTimeout = tonumber(settings[9])\\n\\nif maxConcurrent ~= nil and weight > maxConcurrent then\\n  return redis.error_reply('OVERWEIGHT:'..weight..':'..maxConcurrent)\\nend\\n\\nlocal reachedHWM = (highWater ~= nil and queueLength == highWater\\n  and not (\\n    conditions_check(capacity, weight)\\n    and nextRequest - now <= 0\\n  )\\n)\\n\\nlocal blocked = strategy == 3 and (reachedHWM or unblockTime >= now)\\n\\nif blocked then\\n  local computedPenalty = penalty\\n  if computedPenalty == nil then\\n    if minTime == 0 then\\n      computedPenalty = 5000\\n    else\\n      computedPenalty = 15 * minTime\\n    end\\n  end\\n\\n  local newNextRequest = now + computedPenalty + minTime\\n\\n  redis.call('hmset', settings_key,\\n    'unblockTime', now + computedPenalty,\\n    'nextRequest', newNextRequest\\n  )\\n\\n  local clients_queued_reset = redis.call('hkeys', client_num_queued_key)\\n  local queued_reset = {}\\n  for i = 1, #clients_queued_reset do\\n    table.insert(queued_reset, clients_queued_reset[i])\\n    table.insert(queued_reset, 0)\\n  end\\n  redis.call('hmset', client_num_queued_key, unpack(queued_reset))\\n\\n  redis.call('publish', 'b_'..id, 'blocked:')\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\nend\\n\\nif not blocked and not reachedHWM then\\n  redis.call('hincrby', client_num_queued_key, client, 1)\\nend\\n\\nreturn {reachedHWM, blocked, strategy}\\n\",\"update_settings.lua\":\"local args = {'hmset', settings_key}\\n\\nfor i = num_static_argv + 1, #ARGV do\\n  table.insert(args, ARGV[i])\\nend\\n\\nredis.call(unpack(args))\\n\\nprocess_tick(now, true)\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"validate_client.lua\":\"if not redis.call('zscore', client_last_seen_key, client) then\\n  return redis.error_reply('UNKNOWN_CLIENT')\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\",\"validate_keys.lua\":\"if not (redis.call('exists', settings_key) == 1) then\\n  return redis.error_reply('SETTINGS_KEY_NOT_FOUND')\\nend\\n\"}")},function(e,t,n){"use strict";var r,i,s=n(1),o=n(2);r=n(6),i=function(){function e(t){s(this,e),this.status=t,this._jobs={},this.counts=this.status.map((function(){return 0}))}return o(e,[{key:"next",value:function(e){var t,n;return n=(t=this._jobs[e])+1,null!=t&&n<this.status.length?(this.counts[t]--,this.counts[n]++,this._jobs[e]++):null!=t?(this.counts[t]--,delete this._jobs[e]):void 0}},{key:"start",value:function(e){return 0,this._jobs[e]=0,this.counts[0]++}},{key:"remove",value:function(e){var t;return null!=(t=this._jobs[e])&&(this.counts[t]--,delete this._jobs[e]),null!=t}},{key:"jobStatus",value:function(e){var t;return null!=(t=this.status[this._jobs[e]])?t:null}},{key:"statusJobs",value:function(e){var t,n,i,s;if(null!=e){if((n=this.status.indexOf(e))<0)throw new r("status must be one of ".concat(this.status.join(", ")));for(t in s=[],i=this._jobs)i[t]===n&&s.push(t);return s}return Object.keys(this._jobs)}},{key:"statusCounts",value:function(){var e=this;return this.counts.reduce((function(t,n,r){return t[e.status[r]]=n,t}),{})}}]),e}(),e.exports=i},function(e,t,n){"use strict";var r,i,s=n(0),o=n(5),a=n(1),u=n(2);function c(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){c(s,r,i,o,a,"next",e)}function a(e){c(s,r,i,o,a,"throw",e)}o(void 0)}))}}r=n(13),i=function(){function e(t,n){a(this,e),this.schedule=this.schedule.bind(this),this.name=t,this.Promise=n,this._running=0,this._queue=new r}return u(e,[{key:"isEmpty",value:function(){return 0===this._queue.length}},{key:"_tryToRun",value:function(){var e=this;return l(s.mark((function t(){var n,r,i,a,u,c,h,p;return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e._running<1&&e._queue.length>0)){t.next=13;break}return e._running++,p=e._queue.shift(),h=p.task,n=p.args,u=p.resolve,a=p.reject,t.next=9,l(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.apply(void 0,o(n));case 3:return c=e.sent,e.abrupt("return",(function(){return u(c)}));case 7:return e.prev=7,e.t0=e.catch(0),i=e.t0,e.abrupt("return",(function(){return a(i)}));case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))();case 9:return r=t.sent,e._running--,e._tryToRun(),t.abrupt("return",r());case 13:case"end":return t.stop()}}),t)})))()}},{key:"schedule",value:function(e){var t,n,r;r=n=null,t=new this.Promise((function(e,t){return r=e,n=t}));for(var i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];return this._queue.push({task:e,args:s,resolve:r,reject:n}),this._tryToRun(),t}}]),e}(),e.exports=i},function(e){e.exports=JSON.parse('{"version":"2.19.5"}')},function(e,t,n){"use strict";var r,i,s,o,a,u,c=n(0),l=n(5),h=n(1),p=n(2);function f(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function d(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function v(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){d(s,r,i,o,a,"next",e)}function a(e){d(s,r,i,o,a,"throw",e)}o(void 0)}))}}u=n(3),r=n(4),o=n(8),s=n(10),a=n(9),i=function(){var e=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};h(this,e),this.deleteKey=this.deleteKey.bind(this),this.limiterOptions=t,u.load(this.limiterOptions,this.defaults,this),this.Events=new r(this),this.instances={},this.Bottleneck=n(11),this._startAutoCleanup(),this.sharedConnection=null!=this.connection,null==this.connection&&("redis"===this.limiterOptions.datastore?this.connection=new o(Object.assign({},this.limiterOptions,{Events:this.Events})):"ioredis"===this.limiterOptions.datastore&&(this.connection=new s(Object.assign({},this.limiterOptions,{Events:this.Events}))))}return p(e,[{key:"key",value:function(){var e,t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return null!=(e=this.instances[n])?e:function(){var e;return e=t.instances[n]=new t.Bottleneck(Object.assign(t.limiterOptions,{id:"".concat(t.id,"-").concat(n),timeout:t.timeout,connection:t.connection})),t.Events.trigger("created",e,n),e}()}},{key:"deleteKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=this;return v(c.mark((function n(){var r,i;return c.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i=t.instances[e],!t.connection){n.next=5;break}return n.next=4,t.connection.__runCommand__(["del"].concat(l(a.allKeys("".concat(t.id,"-").concat(e)))));case 4:r=n.sent;case 5:if(null==i){n.next=9;break}return delete t.instances[e],n.next=9,i.disconnect();case 9:return n.abrupt("return",null!=i||r>0);case 10:case"end":return n.stop()}}),n)})))()}},{key:"limiters",value:function(){var e,t,n,r;for(e in n=[],t=this.instances)r=t[e],n.push({key:e,limiter:r});return n}},{key:"keys",value:function(){return Object.keys(this.instances)}},{key:"clusterKeys",value:function(){var e=this;return v(c.mark((function t(){var n,r,i,s,o,a,u,l,h,p,d;return c.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=e.connection){t.next=2;break}return t.abrupt("return",e.Promise.resolve(e.keys()));case 2:a=[],n=null,h="b_".concat(e.id,"-").length,r="_settings".length;case 6:if(0===n){t.next=17;break}return t.next=9,e.connection.__runCommand__(["scan",null!=n?n:0,"match","b_".concat(e.id,"-*_settings"),"count",1e4]);case 9:for(p=t.sent,d=f(p,2),l=d[0],i=d[1],n=~~l,s=0,u=i.length;s<u;s++)o=i[s],a.push(o.slice(h,-r));t.next=6;break;case 17:return t.abrupt("return",a);case 18:case"end":return t.stop()}}),t)})))()}},{key:"_startAutoCleanup",value:function(){var e,t=this;return clearInterval(this.interval),"function"===typeof(e=this.interval=setInterval(v(c.mark((function e(){var n,r,i,s,o,a;return c.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=Date.now(),i=t.instances,s=[],e.t0=c.keys(i);case 4:if((e.t1=e.t0()).done){e.next=23;break}return r=e.t1.value,a=i[r],e.prev=7,e.next=10,a._store.__groupCheck__(o);case 10:if(!e.sent){e.next=14;break}s.push(t.deleteKey(r)),e.next=15;break;case 14:s.push(void 0);case 15:e.next=21;break;case 17:e.prev=17,e.t2=e.catch(7),n=e.t2,s.push(a.Events.trigger("error",n));case 21:e.next=4;break;case 23:return e.abrupt("return",s);case 24:case"end":return e.stop()}}),e,null,[[7,17]])}))),this.timeout/2)).unref?e.unref():void 0}},{key:"updateSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(u.overwrite(e,this.defaults,this),u.overwrite(e,e,this.limiterOptions),null!=e.timeout)return this._startAutoCleanup()}},{key:"disconnect",value:function(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.sharedConnection)return null!=(e=this.connection)?e.disconnect(t):void 0}}]),e}();return e.prototype.defaults={timeout:3e5,connection:null,Promise:Promise,id:"group-key"},e}.call(void 0),e.exports=i},function(e,t,n){"use strict";var r,i,s,o=n(1),a=n(2);s=n(3),i=n(4),r=function(){var e=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,e),this.options=t,s.load(this.options,this.defaults,this),this.Events=new i(this),this._arr=[],this._resetPromise(),this._lastFlush=Date.now()}return a(e,[{key:"_resetPromise",value:function(){var e=this;return this._promise=new this.Promise((function(t,n){return e._resolve=t}))}},{key:"_flush",value:function(){return clearTimeout(this._timeout),this._lastFlush=Date.now(),this._resolve(),this.Events.trigger("batch",this._arr),this._arr=[],this._resetPromise()}},{key:"add",value:function(e){var t,n=this;return this._arr.push(e),t=this._promise,this._arr.length===this.maxSize?this._flush():null!=this.maxTime&&1===this._arr.length&&(this._timeout=setTimeout((function(){return n._flush()}),this.maxTime)),t}}]),e}();return e.prototype.defaults={maxTime:null,maxSize:null,Promise:Promise},e}.call(void 0),e.exports=r},function(e,t,n){"use strict";n.r(t),n.d(t,"Automation",(function(){return Q}));var r=n(0),i=n.n(r);function s(e,t,n,r,i,s,o){try{var a=e[s](o),u=a.value}catch(c){return void n(c)}a.done?t(u):Promise.resolve(u).then(r,i)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){s(o,r,i,a,u,"next",e)}function u(e){s(o,r,i,a,u,"throw",e)}a(void 0)}))}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function c(e,t){if(e){if("string"===typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function l(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}}(e,t)||c(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,n){return(d=f()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&p(i,n.prototype),i}).apply(null,arguments)}function v(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var _=Symbol("Comlink.proxy"),y=Symbol("Comlink.endpoint"),m=Symbol("Comlink.releaseProxy"),g=Symbol("Comlink.thrown"),b=function(e){return"object"===typeof e&&null!==e||"function"===typeof e},k=new Map([["proxy",{canHandle:function(e){return b(e)&&e[_]},serialize:function(e){var t=new MessageChannel,n=t.port1,r=t.port2;return w(e,n),[r,[r]]},deserialize:function(e){return e.start(),E(e,[],t);var t}}],["throw",{canHandle:function(e){return b(e)&&g in e},serialize:function(e){var t=e.value;return[t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[]]},deserialize:function(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self;t.addEventListener("message",(function n(r){if(r&&r.data){var i,s=Object.assign({path:[]},r.data),o=s.id,a=s.type,u=s.path,c=(r.data.argumentList||[]).map(A);try{var p=u.slice(0,-1).reduce((function(e,t){return e[t]}),e),f=u.reduce((function(e,t){return e[t]}),e);switch(a){case 0:i=f;break;case 1:p[u.slice(-1)[0]]=A(r.data.value),i=!0;break;case 2:i=f.apply(p,c);break;case 3:var _;i=P(d(f,v(c)));break;case 4:var y=new MessageChannel,m=y.port1,b=y.port2;w(e,b),i=I(m,[m]);break;case 5:i=void 0}}catch(_){i=h({value:_},g,0)}Promise.resolve(i).catch((function(e){return h({value:e},g,0)})).then((function(e){var r=l(j(e),2),i=r[0],s=r[1];t.postMessage(Object.assign(Object.assign({},i),{id:o}),s),5===a&&(t.removeEventListener("message",n),x(t))}))}})),t.start&&t.start()}function x(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function R(e){if(e)throw new Error("Proxy has been released and is not useable")}function E(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},r=!1,i=new Proxy(n,{get:function(n,s){if(R(r),s===m)return function(){return C(e,{type:5,path:t.map((function(e){return e.toString()}))}).then((function(){x(e),r=!0}))};if("then"===s){if(0===t.length)return{then:function(){return i}};var o=C(e,{type:0,path:t.map((function(e){return e.toString()}))}).then(A);return o.then.bind(o)}return E(e,[].concat(v(t),[s]))},set:function(n,i,s){R(r);var o=l(j(s),2),a=o[0],u=o[1];return C(e,{type:1,path:[].concat(v(t),[i]).map((function(e){return e.toString()})),value:a},u).then(A)},apply:function(n,i,s){R(r);var o=t[t.length-1];if(o===y)return C(e,{type:4}).then(A);if("bind"===o)return E(e,t.slice(0,-1));var a=l(O(s),2),u=a[0],c=a[1];return C(e,{type:2,path:t.map((function(e){return e.toString()})),argumentList:u},c).then(A)},construct:function(n,i){R(r);var s=l(O(i),2),o=s[0],a=s[1];return C(e,{type:3,path:t.map((function(e){return e.toString()})),argumentList:o},a).then(A)}});return i}function O(e){var t,n=e.map(j);return[n.map((function(e){return e[0]})),(t=n.map((function(e){return e[1]})),Array.prototype.concat.apply([],t))]}var S=new WeakMap;function I(e,t){return S.set(e,t),e}function P(e){return Object.assign(e,h({},_,!0))}function j(e){var t,n=function(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=c(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}(k);try{for(n.s();!(t=n.n()).done;){var r=l(t.value,2),i=r[0],s=r[1];if(s.canHandle(e)){var o=l(s.serialize(e),2);return[{type:3,name:i,value:o[0]},o[1]]}}}catch(a){n.e(a)}finally{n.f()}return[{type:0,value:e},S.get(e)||[]]}function A(e){switch(e.type){case 3:return k.get(e.name).deserialize(e.value);case 0:return e.value}}function C(e,t,n){return new Promise((function(r){var i=new Array(4).fill(0).map((function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)})).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===i&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:i},t),n)}))}var T,q=n(16),L=n.n(q),D=n(17),G=n.n(D);!function(e){e.Get="get",e.Post="post",e.Put="put"}(T||(T={}));var M="https://api.spacetraders.io",N=new G.a({minTime:500,maxConcurrent:1}),z=function(e){return new Promise((function(t){return setTimeout(t,e)}))};function K(e,t,n){return U.apply(this,arguments)}function U(){return(U=o(i.a.mark((function e(t,n,r){var s,o,a,u,c,l,h=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=h.length>3&&void 0!==h[3]?h[3]:{},o=h.length>4&&void 0!==h[4]?h[4]:0,r!==T.Get){e.next=8;break}return e.next=5,N.schedule((function(){return fetch(t,{method:r,headers:{Authorization:"Bearer ".concat(n)}})}));case 5:a=e.sent,e.next=11;break;case 8:return e.next=10,N.schedule((function(){return fetch(t,{method:r,headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify(s)})}));case 10:a=e.sent;case 11:if(!(429===a.status&&o<3)){e.next=17;break}return u=a.headers.get("retry-after"),c=u?1e3*parseInt(u,10):1e3,e.next=16,z(c);case 16:K(t,n,r,s,o+1);case 17:if(401!==a.status){e.next=19;break}throw new Error("Invalid username or token.");case 19:return e.next=21,a.json();case 21:if(l=e.sent,!(a.status>=400)){e.next=24;break}throw new Error(l.error.message);case 24:return e.abrupt("return",l);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var V,B=function(e,t,n){return o(i.a.mark((function r(){var s;return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s="".concat(M,"/users/").concat(t,"/ships/").concat(n),r.abrupt("return",K(s,e,T.Get));case 2:case"end":return r.stop()}}),r)})))()},F=function(e,t){return o(i.a.mark((function n(){var r;return i.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r="".concat(M,"/game/locations/").concat(t,"/marketplace"),n.abrupt("return",K(r,e,T.Get));case 2:case"end":return n.stop()}}),n)})))()},W=function(e,t,n,r,s){return o(i.a.mark((function o(){var a;return i.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a="".concat(M,"/users/").concat(t,"/purchase-orders"),i.abrupt("return",K(a,e,T.Post,{shipId:n,good:r,quantity:s}));case 2:case"end":return i.stop()}}),o)})))()},H=function(e,t,n,r,s){return o(i.a.mark((function o(){var a;return i.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a="".concat(M,"/users/").concat(t,"/sell-orders"),i.abrupt("return",K(a,e,T.Post,{shipId:n,good:r,quantity:s}));case 2:case"end":return i.stop()}}),o)})))()},Y=function(e,t,n,r){return o(i.a.mark((function s(){var o;return i.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return o="".concat(M,"/users/").concat(t,"/flight-plans"),i.abrupt("return",K(o,e,T.Post,{shipId:n,destination:r}));case 2:case"end":return i.stop()}}),s)})))()};!function(e){e[e.Travel=0]="Travel",e[e.Buy=1]="Buy",e[e.Sell=2]="Sell"}(V||(V={}));var Q=function(){function e(t,n,r,i,s,o,a,u,c){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.token=void 0,this.username=void 0,this.stepIndex=0,this.steps=void 0,this.timer=null,this.repeat=!0,this.ship=void 0,this.credits=void 0,this.marketData=null,this.errorCallback=void 0,this.stateUpdateCallback=void 0,this.webworkerGetLocalStorage=void 0,this.webworkerUpdateMarketData=void 0,this.enabled=!1,this.token=t,this.username=n,this.steps=r,this.ship=i,this.credits=s,this.errorCallback=o,this.stateUpdateCallback=a,this.webworkerGetLocalStorage=u,this.webworkerUpdateMarketData=c}var t,n,r;return t=e,(n=[{key:"run",value:function(){this.enabled=!0,this.doStep()}},{key:"stop",value:function(){this.enabled=!1}},{key:"setMarketData",value:function(e){this.marketData=e?JSON.parse(e):null}},{key:"nextStep",value:function(){null!==this.steps?(null!==this.timer&&this.timer.removeEventListener("targetAchieved",this.nextStep),this.stepIndex+1===this.steps.steps.length&&this.repeat?this.stepIndex=0:this.stepIndex+1!==this.steps.steps.length||this.repeat?this.stepIndex+=1:this.enabled=!1,this.enabled&&this.doStep()):this.enabled=!1}},{key:"doStep",value:function(){var e=o(i.a.mark((function e(){var t,n,r,s,o,a,u,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this.steps){e.next=3;break}return this.enabled=!1,e.abrupt("return");case 3:return e.next=5,B(this.token,this.username,this.ship.id);case 5:if(this.ship=e.sent.ship,e.prev=6,this.steps.steps[this.stepIndex].type.action!==V.Travel){e.next=17;break}return e.next=10,Y(this.token,this.username,this.steps.shipId,this.steps.steps[this.stepIndex].type.destination);case 10:t=e.sent,this.stateUpdateCallback({type:V.Travel,data:t.flightPlan}),this.timer=new L.a,this.timer.start({precision:"seconds",target:{seconds:t.flightPlan.timeRemainingInSeconds+5}}),this.timer.addEventListener("targetAchieved",this.nextStep.bind(this)),e.next=45;break;case 17:if(this.steps.steps[this.stepIndex].type.action!==V.Buy){e.next=37;break}if(-1!==this.steps.steps[this.stepIndex].type.quantity){e.next=30;break}return e.next=21,this.getMarketData(this.steps.steps[this.stepIndex].type.good);case 21:if(r=e.sent){e.next=24;break}throw new Error("Cargo type ".concat(r," does not exist at ").concat(this.ship.location));case 24:return s=this.getMaxQuantity(r),e.next=27,W(this.token,this.username,this.steps.shipId,this.steps.steps[this.stepIndex].type.good,s);case 27:n=e.sent,e.next=33;break;case 30:return e.next=32,W(this.token,this.username,this.steps.shipId,this.steps.steps[this.stepIndex].type.good,this.steps.steps[this.stepIndex].type.quantity);case 32:n=e.sent;case 33:this.credits=n.credits,this.stateUpdateCallback({type:V.Buy,data:n}),e.next=44;break;case 37:return o=this.steps.steps[this.stepIndex].type,-1===(a=o.quantity)&&(a=this.ship.cargo.find((function(e){return e.good===c.steps.steps[c.stepIndex].type.good})).quantity),e.next=41,H(this.token,this.username,this.steps.shipId,this.steps.steps[this.stepIndex].type.good,a);case 41:u=e.sent,this.credits=u.credits,this.stateUpdateCallback({type:V.Sell,data:u});case 44:this.nextStep();case 45:e.next=51;break;case 47:e.prev=47,e.t0=e.catch(6),this.stop(),this.errorCallback({shipId:this.steps.shipId,error:e.t0.message});case 51:case"end":return e.stop()}}),e,this,[[6,47]])})));return function(){return e.apply(this,arguments)}}()},{key:"getMarketData",value:function(){var e=o(i.a.mark((function e(t){var n,r,s,o=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.webworkerGetLocalStorage(this),r=null===(n=this.marketData)||void 0===n?void 0:n.find((function(e){return e.planet.symbol===o.ship.location})),this.marketData&&r&&!(Date.now()-r.updatedAt>6e5)){e.next=8;break}return e.next=5,F(this.token,this.ship.location);case 5:return s=e.sent,this.webworkerUpdateMarketData(s),e.abrupt("return",s.location.marketplace.find((function(e){return e.symbol===t})));case 8:return e.abrupt("return",r.planet.marketplace.find((function(e){return e.symbol===t})));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getMaxQuantity",value:function(e){var t=Math.floor(this.ship.spaceAvailable/e.volumePerUnit);return t*e.pricePerUnit<this.credits&&t<=e.quantityAvailable?t:t>e.quantityAvailable?e.quantityAvailable:Math.floor(this.credits/e.pricePerUnit)}}])&&a(t.prototype,n),r&&a(t,r),e}();w(Q)}]);
//# sourceMappingURL=webworker.64d915ba.worker.js.map